<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>
        function UserRegistration() {
            var form = document.getElementById("formNewUser");
            var formData = new FormData(form);

            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "http://" + window.location.host + "/registration", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(formData);

            xhttp.onreadystatechange = function() {//Вызывает функцию при смене состояния.
                if(xhttp.readyState === XMLHttpRequest.DONE && xhttp.status === 200) {
                    var response = JSON.parse(xhttp.responseText);
                    ReadResponse(response, formData);
                }
            }
        }

        function ReadResponse(response, formData) {
            console.log(response.success + " " + response.error);
            if (response.success) {

                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", "http://" + window.location.host + "/login", true);
                xhttp.setRequestHeader("Content-type", "application/json");
                xhttp.send(formData);
                var responseLogin = JSON.parse(xhttp.responseText);

                if (responseLogin) {
                    var button = document.getElementById("button");
                    button.value = "Перейти в лобби";
                    button.onclick = function () {
                        location.href = "../../lobby"
                    }
                }

            } else {

                var errorDiv = document.getElementById("error");

                if (response.error === "form is empty") {
                    errorDiv.innerHTML = "Не все формы заполнены"
                }
                if (response.error === "login busy") {
                    errorDiv.innerHTML = "Этот логин уже занят"
                }
                if (response.error === "email busy") {
                    errorDiv.innerHTML = "Эта почта уже используется"
                }
                if (response.error === "password error") {
                    errorDiv.innerHTML = "Пароли не совпадают"
                }
            }
        }
    </script>
</head>
<body>
<iframe name="iframe1" style="position: absolute; left: -9999px;"></iframe>

<form method="POST" id="formNewUser" target="iframe1">

    <table align="center">
        <tr>
            <td> Логин: </td>
            <td> <input type="text" name="username"> </td>
        </tr>
        <tr>
            <td> Почта: </td>
            <td> <input type="text" name="email"> </td>
        </tr>
        <tr>
            <td> Пароль: </td>
            <td> <input type="password" name="password"> </td>
        </tr>
        <tr>
            <td> Подтвердите пароль: </td>
            <td> <input type="password" name="confirm_password"> </td>
        </tr>
        <tr>
            <td> <input id="button" type="submit" value="Регистрация" onclick="UserRegistration()"> </td>
        </tr>
        <tr>
            <td> <div id="error"></div> </td>
        </tr>
    </table>

</form>

</body>
</html>